'use strict';var initJsonKeyValueWidget=function(fieldName,inlinePrefix){if(fieldName.indexOf('__prefix__')>-1){return;}
var $=django.jQuery;if(fieldName.indexOf('inline')>-1){var inlineClass=$('#id_'+fieldName).parents('.inline-related').attr('class');if(inlineClass.indexOf('tabular')>-1){return;}}
var retrieveTemplate=function(templateName,fieldName){var template=$('#'+templateName+'-'+fieldName);if(template.length){return template.html();}
else{var html=$('.'+templateName+'-inline').html();html=html.replace(/__prefix__/g,inlinePrefix);return html;}};var compileUI=function(params){var fieldId='id_'+fieldName,originalTextarea=$('#'+fieldId),originalValue=originalTextarea.val(),originalContainer=originalTextarea.parents('.form-row').eq(0),errorHtml=originalContainer.find('.errorlist').html(),jsonData={'':''};if(originalValue!==''&&originalValue!=='{}'){try{jsonData=JSON.parse(originalValue);}
catch(e){alert('invalid JSON:\n'+e);return false;}}
var fieldData={'id':fieldId,'label':originalContainer.find('label').text(),'name':fieldName,'value':originalTextarea.val(),'help':originalContainer.find('.help').text(),'errors':errorHtml,'data':jsonData},uiHtml=retrieveTemplate('flat-json-ui-template',fieldName),compiledUiHtml=_.template(uiHtml)(fieldData);if(params&&params.replaceOriginal===true){originalTextarea.remove();originalContainer.after(compiledUiHtml).hide();}
return compiledUiHtml;};compileUI({replaceOriginal:true});var row_html=retrieveTemplate('flat-json-row-template',fieldName),emptyRow=_.template(row_html)({'key':'','value':''}),$json=$('#id_'+fieldName).parents('.flat-json');var updateTextarea=function(container){var newValue={},rawTextarea=container.find('textarea'),rows=container.find('.form-row');rows.each(function(){var inputs=$(this).find('input'),key=inputs.eq(0).val(),value=inputs.eq(1).val();newValue[key]=value;});$(rawTextarea).val(JSON.stringify(newValue,null,4));};$json.delegate('a.flat-json-remove-row','click',function(e){e.preventDefault();$(this).parents('.form-row').eq(0).remove();updateTextarea($json);});$json.delegate('a.flat-json-add-row','click',function(e){e.preventDefault();$json.find('.flat-json-rows').append(emptyRow);});$json.delegate('.flat-json-toggle-textarea','click',function(e){e.preventDefault();var rawTextarea=$json.find('.flat-json-textarea'),jsonRows=$json.find('.flat-json-rows'),addRow=$json.find('.flat-json-add-row');if(rawTextarea.css('display')!=='none'){var compiledUi=compileUI();if(compiledUi===false){return;}
var $ui=$($.parseHTML(compiledUi));jsonRows.html($ui.find('.flat-json-rows').html());rawTextarea.hide();jsonRows.show();addRow.show();}
else{rawTextarea.show();jsonRows.hide();addRow.hide();}});$json.delegate('input[type=text]','input propertychange',function(){updateTextarea($json);});};django.jQuery(function($){if(typeof django.jsonWidgetBoundInlines==='undefined'){$('form').delegate('.inline-group .add-row a','click',function(){var jsonOriginalTextareas=$(this).parents('.inline-group').eq(0).find('.flat-json-original-textarea');if(jsonOriginalTextareas.length>0){$(this).parents('.inline-group').find('.inline-related').each(function(e,i){var prefix=i;$(this).find('.flat-json-original-textarea').each(function(){var fieldName=$(this).attr('name');if(fieldName.indexOf('prefix')>-1){return;}
initJsonKeyValueWidget(fieldName,prefix);});});}});django.jsonWidgetBoundInlines=true;}});